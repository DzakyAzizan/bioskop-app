<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cinema Tix - Professional Print</title>
    <style>
        :root { --primary: #e50914; --bg: #0b0b0b; --card: #161616; --text: #fff; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        .container { max-width: 500px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; }
        .selection-group { display: flex; gap: 10px; margin-bottom: 20px; }
        select { padding: 12px; background: #222; color: white; border: 1px solid #444; flex: 1; border-radius: 5px; }
        .grid-seats { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 20px 0; }
        .seat { padding: 12px; background: #444; text-align: center; cursor: pointer; border-radius: 4px; font-size: 14px; }
        .seat.occupied { background: #1a1a1a; color: #333; cursor: not-allowed; }
        .seat.selected { background: var(--primary); color: white; }
        .btn-confirm { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        #ticket-controls { display: none; margin-top: 20px; padding: 15px; background: #222; border-radius: 8px; text-align: center; }
        .btn-print { background: #28a745; color: white; border: none; padding: 15px; cursor: pointer; border-radius: 5px; width: 100%; font-weight: bold; font-size: 16px; margin-bottom: 10px; }
        
        /* Tampilan Tiket di Layar */
        .ticket { background: white; color: black; padding: 15px; border-radius: 8px; border: 2px dashed #000; margin-bottom: 15px; position: relative; }
        .ticket-checkbox { position: absolute; top: 15px; right: 15px; transform: scale(1.4); }
        .ticket h2 { color: #e50914; text-align: center; margin: 0 0 10px 0; font-size: 18px; border-bottom: 1px solid #eee; }
        .ticket-info div { display: flex; justify-content: space-between; border-bottom: 1px dotted #ccc; padding: 4px 0; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container" id="main-content">
        <div class="header">
            <div>User: <span id="user-display" style="color:var(--primary); font-weight:bold;"></span></div>
            <button onclick="logout()">Logout</button>
        </div>
        <div class="selection-group">
            <select id="movie-select" onchange="loadSeats()">
                <option value="M1">Avengers</option><option value="M2">Spider-Man</option>
                <option value="M3">The Batman</option><option value="M4">Ant-Man</option>
            </select>
            <select id="showtime-select" onchange="loadSeats()">
                <option value="14:00">14:00</option><option value="17:00">17:00</option><option value="22:00">22:00</option>
            </select>
        </div>
        <div id="seat-container" class="grid-seats"></div>
        <button class="btn-confirm" onclick="confirmBooking()">KONFIRMASI PESANAN</button>
        
        <div id="ticket-controls">
            <button class="btn-print" onclick="printWithNewWindow()">CETAK KE PDF (ANTI-KOSONG)</button>
            <button onclick="clearHistory()" style="width:100%; border:none; background:none; color:#888; padding:10px;">Hapus Semua Riwayat</button>
        </div>

        <div id="ticket-container"></div>
    </div>

    <script>
        const user = localStorage.getItem("userName");
        if (!user) window.location.href = "login.html";
        document.getElementById("user-display").innerText = user;

        async function loadSeats() {
            const m = document.getElementById("movie-select").value;
            const s = document.getElementById("showtime-select").value;
            try {
                const res = await fetch(`/api/seats/${m}/${s}`);
                const seats = await res.json();
                const container = document.getElementById("seat-container");
                container.innerHTML = "";
                seats.forEach(seat => {
                    const div = document.createElement("div");
                    div.className = `seat ${seat.status}`;
                    div.innerText = seat.seat_id;
                    if (seat.status === "available") div.onclick = () => div.classList.toggle("selected");
                    div.dataset.id = seat.seat_id;
                    container.appendChild(div);
                });
            } catch (e) { console.error(e); }
        }

        async function confirmBooking() {
            const sel = Array.from(document.querySelectorAll(".seat.selected")).map(s => s.dataset.id);
            if (sel.length === 0) return alert("Pilih kursi dulu!");
            const m = document.getElementById("movie-select").value;
            const s = document.getElementById("showtime-select").value;
            
            const res = await fetch("/api/book-seat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ movieId: m, seatIds: sel, userName: user, showtime: s })
            });

            if (res.ok) {
                const data = { 
                    movie: document.getElementById("movie-select").options[document.getElementById("movie-select").selectedIndex].text, 
                    time: s, seats: sel.join(", "), id: Math.random().toString(36).substr(2, 7).toUpperCase() 
                };
                const history = JSON.parse(localStorage.getItem(`hist_${user}`)) || [];
                history.unshift(data);
                localStorage.setItem(`hist_${user}`, JSON.stringify(history));
                renderTicket(data);
                loadSeats();
                document.getElementById("ticket-controls").style.display = "block";
                alert("Berhasil!");
            }
        }

        function renderTicket(data) {
            const t = document.createElement("div");
            t.className = "ticket";
            t.innerHTML = `
                <input type="checkbox" class="ticket-checkbox" checked>
                <h2>CINEMA TIX</h2>
                <div class="ticket-info">
                    <div><strong>Film:</strong><span>${data.movie}</span></div>
                    <div><strong>Jam:</strong><span>${data.time}</span></div>
                    <div><strong>Kursi:</strong><span>${data.seats}</span></div>
                </div>
                <div style="text-align:center;font-size:10px;margin-top:8px;">ID: ${data.id}</div>
            `;
            document.getElementById("ticket-container").prepend(t);
        }

        // FUNGSI BARU: Solusi khusus untuk HP agar tidak putih/kosong
        function printWithNewWindow() {
            const checkboxes = document.querySelectorAll(".ticket-checkbox");
            let ticketHtml = "";
            let count = 0;

            checkboxes.forEach((cb) => {
                if (cb.checked) {
                    const ticketElement = cb.parentElement.cloneNode(true);
                    // Hapus checkbox dari tampilan cetak
                    ticketElement.querySelector(".ticket-checkbox").remove();
                    // Style khusus untuk lembaran cetak
                    ticketHtml += `
                        <div style="background:white; color:black; padding:20px; border:2px solid black; margin-bottom:30px; font-family:sans-serif; width:90%; margin-left:auto; margin-right:auto; page-break-inside:avoid;">
                            <h1 style="text-align:center; color:#e50914; border-bottom:2px solid #eee; margin:0 0 10px 0;">CINEMA TIX</h1>
                            <div style="font-size:16px; line-height:1.6;">
                                ${ticketElement.querySelector(".ticket-info").innerHTML}
                            </div>
                            <div style="text-align:center; font-size:12px; margin-top:15px; border-top:1px solid #ccc; padding-top:5px;">
                                ${ticketElement.querySelector("div:last-child").innerHTML}
                            </div>
                        </div>
                    `;
                    count++;
                }
            });

            if (count === 0) return alert("Pilih tiket yang ingin dicetak!");

            // Buat jendela baru (Metode ini paling stabil di HP)
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head><title>Cetak Tiket</title></head>
                <body onload="window.print();window.close()">
                    ${ticketHtml}
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function clearHistory() { if (confirm("Hapus semua?")) { localStorage.removeItem(`hist_${user}`); location.reload(); } }
        function logout() { localStorage.clear(); window.location.href = "login.html"; }

        loadSeats();
        const saved = JSON.parse(localStorage.getItem(`hist_${user}`)) || [];
        saved.forEach(renderTicket);
        if (saved.length > 0) document.getElementById("ticket-controls").style.display = "block";
    </script>
</body>
</html>
