<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cinema Tix - Booking History</title>
    <style>
      :root {
        --primary: #e50914;
        --bg: #0b0b0b;
        --card: #161616;
        --text: #fff;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: var(--bg);
        color: var(--text);
        padding: 20px;
        margin: 0;
      }
      .container {
        max-width: 500px;
        margin: auto;
      }

      /* Header & Selections */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--card);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #333;
      }
      .user-name {
        color: var(--primary);
        font-weight: bold;
      }
      .selection-group {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 20px;
      }
      select {
        padding: 12px;
        background: #222;
        color: white;
        border: 1px solid #444;
        flex: 1;
        border-radius: 5px;
      }

      /* Seat Grid */
      .grid-seats {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
        margin: 20px 0;
      }
      .seat {
        padding: 12px;
        background: #444;
        text-align: center;
        cursor: pointer;
        border-radius: 4px;
        font-size: 14px;
      }
      .seat.occupied {
        background: #1a1a1a;
        color: #333;
        cursor: not-allowed;
      }
      .seat.selected {
        background: var(--primary);
        color: white;
      }

      /* Buttons */
      .btn-confirm {
        width: 100%;
        background: var(--primary);
        color: white;
        border: none;
        padding: 15px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        margin-bottom: 10px;
      }
      .btn-print-selected {
        background: #28a745;
        color: white;
        border: none;
        padding: 12px;
        cursor: pointer;
        border-radius: 5px;
        font-weight: bold;
        width: 100%;
      }
      .btn-clear {
        margin-top: 10px;
        background: #444;
        color: white;
        border: none;
        padding: 8px;
        width: 100%;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
      }

      #ticket-controls {
        display: none;
        margin-top: 20px;
        padding: 15px;
        background: #222;
        border-radius: 8px;
        text-align: center;
        border: 1px solid #333;
      }

      /* Tiket Styling */
      #ticket-container {
        margin-top: 20px;
      }
      .ticket {
        background: white;
        color: black;
        padding: 20px;
        border-radius: 12px;
        border: 2px dashed #000;
        margin-bottom: 20px;
        position: relative;
      }
      .ticket-checkbox {
        position: absolute;
        top: 15px;
        right: 15px;
        transform: scale(1.6);
        cursor: pointer;
      }
      .ticket h2 {
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
        margin-top: 0;
        color: var(--primary);
        text-align: center;
      }
      .ticket-info div {
        display: flex;
        justify-content: space-between;
        border-bottom: 1px dotted #ccc;
        padding: 5px 0;
      }
      .ticket-footer {
        text-align: center;
        margin-top: 10px;
        font-size: 10px;
        color: #666;
        border-top: 1px dashed #ccc;
        padding-top: 5px;
      }

      /* Media Print - Menangani PDF Kosong */
      @media print {
        body * {
          visibility: hidden;
        }
        #ticket-container,
        #ticket-container * {
          visibility: visible;
        }
        .ticket {
          display: none !important;
        }
        .ticket.to-print {
          display: block !important;
          position: relative;
          margin: 20px auto;
          width: 90%;
          border: 2px solid #000;
          page-break-after: always;
        }
        .ticket-checkbox,
        button,
        select,
        .header,
        .btn-confirm,
        .btn-clear {
          display: none !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div>User: <span id="user-display" class="user-name"></span></div>
        <button type="button" onclick="logout()">Logout</button>
      </div>

      <div class="selection-group">
        <select id="movie-select" title="Pilih Film" onchange="loadSeats()">
          <option value="M1">Avengers</option>
          <option value="M2">Spider-Man</option>
          <option value="M3">The Batman</option>
          <option value="M4">Ant-Man</option>
        </select>
        <select id="showtime-select" title="Pilih Jam Tayang" onchange="loadSeats()">
          <option value="14:00">14:00</option>
          <option value="17:00">17:00</option>
          <option value="22:00">22:00</option>
        </select>
      </div>

      <div id="seat-container" class="grid-seats"></div>
      <button type="button" class="btn-confirm" onclick="confirmBooking()">KONFIRMASI PESANAN</button>

      <div id="ticket-controls">
        <button type="button" class="btn-print-selected" onclick="printSelectedTickets()">CETAK TIKET TERPILIH</button>
        <button type="button" class="btn-clear" onclick="clearHistory()">HAPUS RIWAYAT TAMPILAN</button>
      </div>

      <div id="ticket-container"></div>
    </div>

    <script>
      const user = localStorage.getItem("userName");
      if (!user) window.location.href = "login.html";
      document.getElementById("user-display").innerText = user;

      const movieNames = { M1: "Avengers", M2: "Spider-Man", M3: "The Batman", M4: "Ant-Man" };

      // Muat Riwayat dari LocalStorage saat refresh
      function loadTicketHistory() {
        const history = JSON.parse(localStorage.getItem(`history_${user}`)) || [];
        if (history.length > 0) {
          document.getElementById("ticket-controls").style.display = "block";
          history.forEach((data) => renderTicket(data));
        }
      }

      async function loadSeats() {
        const m = document.getElementById("movie-select").value;
        const s = document.getElementById("showtime-select").value;
        try {
          const res = await fetch(`/api/seats/${m}/${s}`);
          const seats = await res.json();
          const container = document.getElementById("seat-container");
          container.innerHTML = "";
          seats.forEach((seat) => {
            const div = document.createElement("div");
            div.className = `seat ${seat.status}`;
            div.innerText = seat.seat_id;
            if (seat.status === "available") div.onclick = () => div.classList.toggle("selected");
            div.dataset.id = seat.seat_id;
            container.appendChild(div);
          });
        } catch (e) {
          console.error("Gagal muat kursi", e);
        }
      }

      async function confirmBooking() {
        const sel = Array.from(document.querySelectorAll(".seat.selected")).map((s) => s.dataset.id);
        const m = document.getElementById("movie-select").value;
        const s = document.getElementById("showtime-select").value;

        if (sel.length === 0) return alert("Pilih kursi!");

        const res = await fetch("/api/book-seat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ movieId: m, seatIds: sel, userName: user, showtime: s }),
        });

        if (res.ok) {
          const ticketData = {
            movie: movieNames[m],
            time: s,
            seats: sel.join(", "),
            id: Math.random().toString(36).substr(2, 9).toUpperCase(),
          };

          // Simpan ke LocalStorage
          const history = JSON.parse(localStorage.getItem(`history_${user}`)) || [];
          history.unshift(ticketData);
          localStorage.setItem(`history_${user}`, JSON.stringify(history));

          document.getElementById("ticket-controls").style.display = "block";
          renderTicket(ticketData);
          loadSeats();
        }
      }

      function renderTicket(data) {
        const tBox = document.getElementById("ticket-container");
        const t = document.createElement("div");
        t.className = "ticket";
        t.innerHTML = `
                <input type="checkbox" class="ticket-checkbox" checked title="Pilih">
                <h2>CINEMA TIX</h2>
                <div class="ticket-info">
                    <div><strong>Film:</strong> <span>${data.movie}</span></div>
                    <div><strong>Jam:</strong> <span>${data.time}</span></div>
                    <div><strong>Kursi:</strong> <span>${data.seats}</span></div>
                </div>
                <div class="ticket-footer">ID: ${data.id}</div>
            `;
        tBox.prepend(t);
      }

      function printSelectedTickets() {
        const all = document.querySelectorAll(".ticket");
        let any = false;
        all.forEach((t) => {
          if (t.querySelector(".ticket-checkbox").checked) {
            t.classList.add("to-print");
            any = true;
          } else {
            t.classList.remove("to-print");
          }
        });
        if (!any) return alert("Centang tiket!");
        window.print();
        all.forEach((t) => t.classList.remove("to-print"));
      }

      function clearHistory() {
        if (confirm("Hapus riwayat tampilan tiket?")) {
          localStorage.removeItem(`history_${user}`);
          document.getElementById("ticket-container").innerHTML = "";
          document.getElementById("ticket-controls").style.display = "none";
        }
      }

      function logout() {
        localStorage.removeItem("userName");
        localStorage.removeItem("userRole");
        window.location.href = "login.html";
      }

      loadSeats();
      loadTicketHistory();
    </script>
  </body>
</html>
